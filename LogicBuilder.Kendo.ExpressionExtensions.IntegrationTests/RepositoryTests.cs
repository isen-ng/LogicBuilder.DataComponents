using AutoMapper;
using AutoMapper.Extensions.ExpressionMapping;
using Contoso.Contexts;
using Contoso.Data.Entities;
using Contoso.Domain.Entities;
using Contoso.Repositories;
using LogicBuilder.Expressions.Utils;
using LogicBuilder.Expressions.Utils.Strutures;
using LogicBuilder.Kendo.ExpressionExtensions.IntegrationTests.AutoMapperProfiles;
using LogicBuilder.Kendo.ExpressionExtensions.IntegrationTests.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Query;
using Microsoft.Extensions.DependencyInjection;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Reflection;
using System.Threading.Tasks;
using LogicBuilder.Kendo.ExpressionExtensions.IntegrationTests.Emulators;
using Microsoft.Extensions.Logging;
using Xunit;

namespace LogicBuilder.Kendo.ExpressionExtensions.IntegrationTests
{
    public class RepositoryTests
    {
        public RepositoryTests()
        {
            Initialize();
        }

        #region Fields
        private IServiceProvider serviceProvider;
        #endregion Fields

        #region Methods
        private void Initialize()
        {
            var database = "ContosoUniVersity";
            var username = "postgres";
            var password = "abcd1234";
            
            var dbEmulator = new PostgresEmulator(
                databaseName: database, 
                username: username,
                password: password);

            Task.Run(async () => await dbEmulator.InitializeAsync()).Wait();

            serviceProvider = new ServiceCollection()
                .AddDbContext<SchoolContext>
                (
                    options =>
                    {
                        var connectionString =
                            $"Host=localhost;Port=5432;Database={database};Username={username};Password={password};";
                        options.UseNpgsql(connectionString);
                        //options.UseInMemoryDatabase("ContosoUniVersity");
                        //options.UseInternalServiceProvider(new ServiceCollection().AddEntityFrameworkInMemoryDatabase().BuildServiceProvider());
                    },
                    ServiceLifetime.Transient
                )
                .AddTransient<ISchoolStore, SchoolStore>()
                .AddTransient<ISchoolRepository, SchoolRepository>()
                .AddSingleton<AutoMapper.IConfigurationProvider>
                (
                    new MapperConfiguration
                    (
                        cfg => 
                        {
                            cfg.AddExpressionMapping();
                            cfg.AddMaps(typeof(SchoolProfile).GetTypeInfo().Assembly);
                        }
                    )
                )
                .AddTransient<IMapper>(sp => new Mapper(sp.GetRequiredService<AutoMapper.IConfigurationProvider>(), sp.GetService))
                .BuildServiceProvider();

            SchoolContext context = serviceProvider.GetRequiredService<SchoolContext>();
            context.Database.EnsureCreated();

            Task.Run(async () => await Seed_Database(serviceProvider.GetRequiredService<ISchoolRepository>())).Wait();
        }
        #endregion Methods

        #region Tests
        [Fact]
        public void Get_enrollments_with_grade_a()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<EnrollmentModel> list = Task.Run(() => 
                repository.GetItemsAsync<EnrollmentModel, Enrollment>(e => e.GradeLetter == "A")).Result;

            Assert.True(list.Count == 1);
        }
        
        [Fact]
        public void Get_students_with_no_includes()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<StudentModel> list = Task.Run(() => repository.GetItemsAsync<StudentModel, Student>()).Result;

            Assert.True(list.Count == 11);
            Assert.True(list.First().Enrollments == null || list.First().Enrollments.Count == 0);
        }

        [Fact]
        public void Get_students_inlude_navigation_property()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<StudentModel> list = Task.Run
            (
                () => repository.GetItemsAsync<StudentModel, Student>
                (
                    s => s.Enrollments.Count > 0, null,
                    new Expression<Func<IQueryable<StudentModel>, IIncludableQueryable<StudentModel, object>>>[]
                    {
                        a => a.Include(x => x.Enrollments)
                    }
                )
            ).Result;

            Assert.True(list.First().Enrollments.Count > 0);
            Assert.Null(list.First().Enrollments.First().CourseTitle);
        }

        [Fact]
        public void Get_students_with_filtered_inlude_no_filter()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<StudentModel> list = Task.Run
            (
                () => repository.GetItemsAsync<StudentModel, Student>
                (
                    s => s.Enrollments.Count > 0, null, null,
                    new FilteredIncludeExpression[]
                    {
                        new FilteredIncludeExpression
                        {
                            Include = LinqHelpers.ToSelector<StudentModel, ICollection<EnrollmentModel>>(i => i.Enrollments)
                        }
                    }
                )
            ).Result;

            Assert.True(list.First().Enrollments.Count > 0);
            Assert.Null(list.First().Enrollments.First().CourseTitle);
        }

        [Fact]
        public void Get_students_with_filtered_inlude_with_filter()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<StudentModel> list = Task.Run
            (
                () => repository.GetItemsAsync<StudentModel, Student>
                (
                    s => s.Enrollments.Count > 0, null, null,
                    new FilteredIncludeExpression[]
                    {
                        new FilteredIncludeExpression
                        {
                            Include = LinqHelpers.ToSelector<StudentModel, ICollection<EnrollmentModel>>(i => i.Enrollments),
                            Filter = LinqHelpers.ToFilter<EnrollmentModel>(e => e.EnrollmentID == -1)
                        }
                    }
                )
            ).Result;

            Assert.True(list.First().Enrollments.Count == 0);
        }

        [Fact]
        public void Get_departments_with_filtered_inlude_no_filter()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<DepartmentModel> list = Task.Run
            (
                () => repository.GetItemsAsync<DepartmentModel, Department>
                (
                    d => d.Courses.Count > 0, null, null,
                    new FilteredIncludeExpression[]
                    {
                        new FilteredIncludeExpression
                        {
                            Include = LinqHelpers.ToSelector<DepartmentModel, ICollection<CourseModel>>(i => i.Courses)
                        }
                    }
                )
            ).Result;

            Assert.True(list.First().Courses.Count > 0);
            Assert.True(list.First().Courses.First().Assignments.Count == 0);
        }

        [Fact]
        public void Get_departments_with_filtered_inlude_with_child_include_no_filters()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<DepartmentModel> list = Task.Run
            (
                () => repository.GetItemsAsync<DepartmentModel, Department>
                (
                    d => d.Courses.Count > 0, null, null,
                    new FilteredIncludeExpression[]
                    {
                        new FilteredIncludeExpression
                        {
                            Include = LinqHelpers.ToSelector<DepartmentModel, ICollection<CourseModel>>(i => i.Courses),
                            FilteredIncludes = new FilteredIncludeExpression[]
                            {
                                new FilteredIncludeExpression
                                {
                                    Include = LinqHelpers.ToSelector<CourseModel, ICollection<CourseAssignmentModel>>(i => i.Assignments)
                                }
                            }
                        }
                    }
                )
            ).Result;

            Assert.True(list.First().Courses.Count > 0);
            Assert.True(list.First().Courses.First().Assignments.Count > 0);
        }

        [Fact]
        public void Get_departments_with_filtered_inlude_with_filter_on_child_include()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<DepartmentModel> list = Task.Run
            (
                () => repository.GetItemsAsync<DepartmentModel, Department>
                (
                    d => d.Courses.Count > 0, null, null,
                    new FilteredIncludeExpression[]
                    {
                        new FilteredIncludeExpression
                        {
                            Include = LinqHelpers.ToSelector<DepartmentModel, ICollection<CourseModel>>(i => i.Courses),
                            FilteredIncludes = new FilteredIncludeExpression[]
                            {
                                new FilteredIncludeExpression
                                {
                                    Include = LinqHelpers.ToSelector<CourseModel, ICollection<CourseAssignmentModel>>(i => i.Assignments),
                                    Filter = LinqHelpers.ToFilter<CourseAssignmentModel>(e => e.CourseID == -1)
                                }
                            }
                        }
                    }
                )
            ).Result;

            Assert.True(list.First().Courses.Count > 0);
            Assert.True(list.First().Courses.First().Assignments.Count == 0);
        }

        [Fact]
        public void Get_instuctors_with_filtered_inlude_conditionally_select_reference_with_valid_condition()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<InstructorModel> list = Task.Run
            (
                () => repository.GetItemsAsync<InstructorModel, Instructor>
                (
                    i => i.OfficeAssignment != null, null, null,
                    new FilteredIncludeExpression[]
                    {
                        new FilteredIncludeExpression
                        {
                            Include = LinqHelpers.ToSelector<InstructorModel, OfficeAssignmentModel>(i => i.OfficeAssignment),
                            Filter = LinqHelpers.ToFilter<OfficeAssignmentModel>(oa => !oa.Location.StartsWith("*"))
                        }
                    }
                )
            ).Result;

            Assert.NotNull(list.First().OfficeAssignment);
        }

        [Fact]
        public void Get_instuctors_with_filtered_inlude_conditionally_select_reference_with_invalid_condition()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<InstructorModel> list = Task.Run
            (
                () => repository.GetItemsAsync<InstructorModel, Instructor>
                (
                    i => i.OfficeAssignment != null, null, null,
                    new FilteredIncludeExpression[]
                    {
                        new FilteredIncludeExpression
                        {
                            Include = LinqHelpers.ToSelector<InstructorModel, OfficeAssignmentModel>(i => i.OfficeAssignment),
                            Filter = LinqHelpers.ToFilter<OfficeAssignmentModel>(oa => oa.Location.StartsWith("*"))
                        }
                    }
                )
            ).Result;

            Assert.Null(list.First().OfficeAssignment);
        }

        [Fact]
        public void Get_students_inlude_navigation_property_of_navigation_property()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<StudentModel> list = Task.Run(() => repository.GetItemsAsync<StudentModel, Student>(s => s.Enrollments.Count() > 0, q => q.OrderBy(s => s.FirstName),
                    new Expression<Func<IQueryable<StudentModel>, IIncludableQueryable<StudentModel, object>>>[]
                    {
                        a => a.Include(x => x.Enrollments).ThenInclude(e => e.CourseTitle)
                    })).Result.ToList();

            Assert.True(list.First().Enrollments.Count > 0);
            Assert.Equal("Arturo", list.First().FirstName);
            Assert.True(list.First().Enrollments.First().CourseTitle.Length > 1);
        }

        [Fact]
        public void Get_students_filter_by_navigation_property_of_navigation_property()
        {
            ISchoolRepository repository = serviceProvider.GetRequiredService<ISchoolRepository>();
            ICollection<StudentModel> list = Task.Run(() => repository.GetItemsAsync<StudentModel, Student>(s => s.Enrollments.Count(e => e.CourseID == 4022) > 0)).Result.ToList();

            Assert.True(list.Count > 0);
        }
        #endregion Tests

        #region Seed DB
        private static async Task Seed_Database(ISchoolRepository repository)
        {
            if ((await repository.CountAsync<StudentModel, Student>()) > 0)
                return;//database has been seeded

            InstructorModel[] instructors = new InstructorModel[]
            {
                new InstructorModel { FirstName = "Roger",   LastName = "Zheng", HireDate = DateTime.Parse("2004-02-12"), EntityState = LogicBuilder.Domain.EntityStateType.Added },
                new InstructorModel { FirstName = "Kim", LastName = "Abercrombie", HireDate = DateTime.Parse("1995-03-11"), EntityState = LogicBuilder.Domain.EntityStateType.Added},
                new InstructorModel { FirstName = "Fadi", LastName = "Fakhouri", HireDate = DateTime.Parse("2002-07-06"), OfficeAssignment = new OfficeAssignmentModel { Location = "Smith 17" }, EntityState = LogicBuilder.Domain.EntityStateType.Added},
                new InstructorModel { FirstName = "Roger", LastName = "Harui", HireDate = DateTime.Parse("1998-07-01"), OfficeAssignment = new OfficeAssignmentModel { Location = "Gowan 27" }, EntityState = LogicBuilder.Domain.EntityStateType.Added },
                new InstructorModel { FirstName = "Candace", LastName = "Kapoor", HireDate = DateTime.Parse("2001-01-15"), OfficeAssignment = new OfficeAssignmentModel { Location = "Thompson 304" }, EntityState = LogicBuilder.Domain.EntityStateType.Added }
            };
            await repository.SaveGraphsAsync<InstructorModel, Instructor>(instructors);

            DepartmentModel[] departments = new DepartmentModel[]
            {
                new DepartmentModel
                {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    Name = "English",     Budget = 350000,
                    StartDate = DateTime.Parse("2007-09-01"),
                    InstructorID = instructors.Single(i => i.FirstName == "Kim" && i.LastName == "Abercrombie").ID,
                    Courses =  new HashSet<CourseModel>
                    {
                        new CourseModel {CourseID = 2021, Title = "Composition",    Credits = 3},
                        new CourseModel {CourseID = 2042, Title = "Literature",     Credits = 4}
                    }
                },
                new DepartmentModel
                {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    Name = "Mathematics",
                    Budget = 100000,
                    StartDate = DateTime.Parse("2007-09-01"),
                    InstructorID = instructors.Single(i => i.FirstName == "Fadi" && i.LastName == "Fakhouri").ID,
                    Courses =  new HashSet<CourseModel>
                    {
                        new CourseModel {CourseID = 1045, Title = "Calculus",       Credits = 4},
                        new CourseModel {CourseID = 3141, Title = "Trigonometry",   Credits = 4}
                    }
                },
                new DepartmentModel
                {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    Name = "Engineering", Budget = 350000,
                    StartDate = DateTime.Parse("2007-09-01"),
                    InstructorID = instructors.Single(i => i.FirstName == "Roger" && i.LastName == "Harui").ID,
                    Courses =  new HashSet<CourseModel>
                    {
                        new CourseModel {CourseID = 1050, Title = "Chemistry",      Credits = 3}
                    }
                },
                new DepartmentModel
                {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    Name = "Economics",
                    Budget = 100000,
                    StartDate = DateTime.Parse("2007-09-01"),
                    InstructorID = instructors.Single(i => i.FirstName == "Candace" && i.LastName == "Kapoor").ID,
                    Courses =  new HashSet<CourseModel>
                    {
                        new CourseModel {CourseID = 4022, Title = "Microeconomics", Credits = 3},
                        new CourseModel {CourseID = 4041, Title = "Macroeconomics", Credits = 3 }
                    }
                }
            };
            await repository.SaveGraphsAsync<DepartmentModel, Department>(departments);

            IEnumerable<CourseModel> courses = departments.SelectMany(d => d.Courses);
            CourseAssignmentModel[] courseInstructors = new CourseAssignmentModel[]
            {
                new CourseAssignmentModel {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    CourseID = courses.Single(c => c.Title == "Chemistry" ).CourseID,
                    InstructorID = instructors.Single(i => i.LastName == "Kapoor").ID
                    },
                new CourseAssignmentModel {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    CourseID = courses.Single(c => c.Title == "Chemistry" ).CourseID,
                    InstructorID = instructors.Single(i => i.LastName == "Harui").ID
                    },
                new CourseAssignmentModel {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    CourseID = courses.Single(c => c.Title == "Microeconomics" ).CourseID,
                    InstructorID = instructors.Single(i => i.LastName == "Zheng").ID
                    },
                new CourseAssignmentModel {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    CourseID = courses.Single(c => c.Title == "Macroeconomics" ).CourseID,
                    InstructorID = instructors.Single(i => i.LastName == "Zheng").ID
                    },
                new CourseAssignmentModel {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    CourseID = courses.Single(c => c.Title == "Calculus" ).CourseID,
                    InstructorID = instructors.Single(i => i.LastName == "Fakhouri").ID
                    },
                new CourseAssignmentModel {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    CourseID = courses.Single(c => c.Title == "Trigonometry" ).CourseID,
                    InstructorID = instructors.Single(i => i.LastName == "Harui").ID
                    },
                new CourseAssignmentModel {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    CourseID = courses.Single(c => c.Title == "Composition" ).CourseID,
                    InstructorID = instructors.Single(i => i.LastName == "Abercrombie").ID
                    },
                new CourseAssignmentModel {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    CourseID = courses.Single(c => c.Title == "Literature" ).CourseID,
                    InstructorID = instructors.Single(i => i.LastName == "Abercrombie").ID
                    },
            };
            await repository.SaveGraphsAsync<CourseAssignmentModel, CourseAssignment>(courseInstructors);

            StudentModel[] students = new StudentModel[]
            {
                new StudentModel
                {
                    EntityState =  LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Carson",   LastName = "Alexander",
                    EnrollmentDate = DateTime.Parse("2010-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Chemistry" ).CourseID,
                            Grade = Contoso.Domain.Entities.Grade.A
                        },
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Microeconomics" ).CourseID,
                            Grade = Contoso.Domain.Entities.Grade.C
                        },
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Macroeconomics" ).CourseID,
                            Grade = Contoso.Domain.Entities.Grade.B
                        }
                    }
                },
                new StudentModel
                {
                    EntityState =  LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Meredith", LastName = "Alonso",
                    EnrollmentDate = DateTime.Parse("2012-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Calculus" ).CourseID,
                            Grade = Contoso.Domain.Entities.Grade.B
                        },
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Trigonometry" ).CourseID,
                            Grade = Contoso.Domain.Entities.Grade.B
                        },
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Composition" ).CourseID,
                            Grade = Contoso.Domain.Entities.Grade.B
                        }
                    }
                },
                new StudentModel
                {
                    EntityState =  LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Arturo",   LastName = "Anand",
                    EnrollmentDate = DateTime.Parse("2013-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Chemistry" ).CourseID
                        },
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Microeconomics").CourseID,
                            Grade = Contoso.Domain.Entities.Grade.B
                        },
                    }
                },
                new StudentModel
                {
                    EntityState =  LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Gytis",    LastName = "Barzdukas",
                    EnrollmentDate = DateTime.Parse("2012-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Chemistry").CourseID,
                            Grade = Contoso.Domain.Entities.Grade.B
                        }
                    }
                },
                new StudentModel
                {
                    EntityState =  LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Yan",      LastName = "Li",
                    EnrollmentDate = DateTime.Parse("2012-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Composition").CourseID,
                            Grade = Contoso.Domain.Entities.Grade.B
                        }
                    }
                },
                new StudentModel
                {
                    EntityState =  LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Peggy",    LastName = "Justice",
                    EnrollmentDate = DateTime.Parse("2011-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = courses.Single(c => c.Title == "Literature").CourseID,
                            Grade = Contoso.Domain.Entities.Grade.B
                        }
                    }
                },
                new StudentModel
                {
                    EntityState =  LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Laura",    LastName = "Norman",
                    EnrollmentDate = DateTime.Parse("2013-09-01")
                },
                new StudentModel
                {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Nino",     LastName = "Olivetto",
                    EnrollmentDate = DateTime.Parse("2005-09-01")
                },
                new StudentModel
                {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Tom",
                    LastName = "Spratt",
                    EnrollmentDate = DateTime.Parse("2010-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = 1045,
                            Grade = Contoso.Domain.Entities.Grade.B
                        }
                    }
                },
                new StudentModel
                {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Billie",
                    LastName = "Spratt",
                    EnrollmentDate = DateTime.Parse("2010-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = 1050,
                            Grade = Contoso.Domain.Entities.Grade.B
                        }
                    }
                },
                new StudentModel
                {
                    EntityState = LogicBuilder.Domain.EntityStateType.Added,
                    FirstName = "Jackson",
                    LastName = "Spratt",
                    EnrollmentDate = DateTime.Parse("2017-09-01"),
                    Enrollments = new HashSet<EnrollmentModel>
                    {
                        new EnrollmentModel
                        {
                            CourseID = 2021,
                            Grade = Contoso.Domain.Entities.Grade.B
                        }
                    }
                }
            };

            await repository.SaveGraphsAsync<StudentModel, Student>(students);
        }
        #endregion Seed DB
    }
}
